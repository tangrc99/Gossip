<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Gossip: Gossip</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="gossip.jpeg"/></td>
  <td id="projectalign">
   <div id="projectname">Gossip<span id="projectnumber">&#160;1.1</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Gossip </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a class="anchor" id="md__Users_tangrenchu_CLionProjects_Gossip_README"></a>Gossip 是 Gossip 协议的一个简单 C++ 实现，采用了 Gossip 协议的反熵模型，并且使用 Push 方法进行节点之间的通信。 项目基于 C++ 17 标准与 grpc 框架。</p>
<h1><a class="anchor" id="autotoc_md4"></a>
使用场景</h1>
<p >项目的使用场景如下：</p><ul>
<li>局域网内多用户数据共享，每个用户是数据生产者，并且数据的生命周期与用户的生命周期基本相同。</li>
<li>局域网内的用户数量不固定，可能会动态变化。</li>
<li>用户对其他用户的数据只具有读权限，而不具备写权限。</li>
<li>可能不具备长时间在线的主机 在这种使用场景下，使用传统的中心式注册服务是不合适的。又因为用户产生的数据与用户主机的存活状态一致，所以考虑使用 gossip 协议进行消息传递。</li>
</ul>
<h1><a class="anchor" id="autotoc_md5"></a>
项目设计</h1>
<h2><a class="anchor" id="autotoc_md6"></a>
消息存储结构</h2>
<ul>
<li>每一台主机需要使用一个唯一名称，并且任何一台主机都会使用该主机名称作为命名空间。不同命名空间的消息允许重复，即不同主机可以使用相同的键值进行消息传递。</li>
<li>内存表使用 命名空间 - 键值对 二级索引。</li>
</ul>
<h2><a class="anchor" id="autotoc_md7"></a>
gossip 协议</h2>
<ul>
<li>采用 push 方法进行节点通信</li>
<li>新节点上线、新消息产生时会产生gossip消息进行谣言传播</li>
<li>节点之间使用心跳机制，并在心跳中交换版本号</li>
<li>节点默认只搜寻本地内存表，如果需要最新消息则使用分布式搜索</li>
</ul>
<h2><a class="anchor" id="autotoc_md8"></a>
grpc 模型</h2>
<ul>
<li>客户端使用异步模型</li>
<li>服务端使用同步模式</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
项目使用</h1>
<h2><a class="anchor" id="autotoc_md10"></a>
客户端连接与控制</h2>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">    // 连接到一个 gossip server, 必须匹配 token 才可以成功连接</div>
<div class="line">    gossip::client::GossipClient client(&quot;127.0.0.1:9999&quot;, &quot;1&quot;);</div>
<div class="line">    </div>
<div class="line">    // 控制当前 gossip server 连接到另外一个 gossip server</div>
<div class="line">    client.connectToNode(&quot;127.0.0.1:8889&quot;);</div>
<div class="line">    </div>
<div class="line">    // 状态信息</div>
<div class="line">    auto res = client.getNodeStatus();</div>
<div class="line">    if(!res.isSucceed()){</div>
<div class="line">        std::cerr &lt;&lt; res.errorText() &lt;&lt; std::endl;</div>
<div class="line">    }else{</div>
<div class="line">        auto status = res.value().dump(4);</div>
<div class="line">        std::cout &lt;&lt; status &lt;&lt; std::endl;</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">//  成功的输出</div>
<div class="line">//    {</div>
<div class="line">//        &quot;external_address&quot;: &quot;127.0.0.1:9999&quot;,</div>
<div class="line">//                &quot;internal_address&quot;: &quot;127.0.0.1:8888&quot;,</div>
<div class="line">//                &quot;mem_use&quot;: 0,</div>
<div class="line">//                &quot;name&quot;: &quot;1&quot;,</div>
<div class="line">//                &quot;peers&quot;: [</div>
<div class="line">//        {</div>
<div class="line">//            &quot;address&quot;: &quot;127.0.0.1:8889&quot;,</div>
<div class="line">//                    &quot;alive&quot;: true,</div>
<div class="line">//                    &quot;name&quot;: &quot;2&quot;</div>
<div class="line">//        }</div>
<div class="line">//        ]</div>
<div class="line">//    }</div>
<div class="line">    </div>
<div class="line"> </div>
<div class="line">    // 关闭服务端</div>
<div class="line">    client.shutdown();</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md11"></a>
客户端 CRUD 操作</h2>
<div class="fragment"><div class="line">{c++}</div>
<div class="line">   // 插入键值对</div>
<div class="line">   auto insert_res = client.insertOrUpdateMessage(&quot;msg&quot;,&quot;content&quot;);</div>
<div class="line">   if(!insert_res.isSucceed()){</div>
<div class="line">       // handle error</div>
<div class="line">   }</div>
<div class="line">   </div>
<div class="line">   // 查找键值对</div>
<div class="line">   auto get_res = client.getMessage(&quot;msg&quot;);</div>
<div class="line">   if(!get_res.isSucceed()){</div>
<div class="line">       // handle error</div>
<div class="line">   }else{</div>
<div class="line">       std::cout &lt;&lt; get_res.value() &lt;&lt; std::endl;</div>
<div class="line">   }</div>
<div class="line"> </div>
<div class="line">   // 删除键值对</div>
<div class="line">   auto del_res = client.deleteMessage(&quot;msg&quot;);</div>
<div class="line">   if(!del_res.isSucceed()){</div>
<div class="line">       // handle error</div>
<div class="line">   }</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md12"></a>
服务端启动</h2>
<div class="fragment"><div class="line">{c++}</div>
<div class="line">   // 创建一个服务实例</div>
<div class="line">   // 名称: name, 唯一名称，用于区分消息的命名空间</div>
<div class="line">   // 客户端服务监听地址: 127.0.0.1:9999, 客户端的访问地址</div>
<div class="line">   // 节点通信接听地址: 127.0.0.1:8888, 节点之间的通信地址</div>
<div class="line">   // 匹配密匙: secret, 非本地客户端需要匹配 secret 才能通信</div>
<div class="line">   GossipNode node(&quot;name&quot;, &quot;127.0.0.1:9999&quot;, &quot;127.0.0.1:8888&quot;,&quot;secret&quot;);</div>
<div class="line"> </div>
<div class="line">   // 启动服务</div>
<div class="line">   node.run();</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md13"></a>
备注</h1>
<p >本项目原本是作为 TinySwarm 中主节点的同步，但由于后期引入 ETCD 作为注册中心，本项目仅作为备选方案。</p>
<p >本项目基本功能已经完成，但还有部分功能没有完成。 </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4
</small></address>
</body>
</html>
